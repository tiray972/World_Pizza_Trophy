# üìã Event Template System Documentation

## Overview

This document describes the **clean and robust event template system** used in the WPT Admin Dashboard.

### Key Principle
**Templates are BLUEPRINTS, not INSTANCES.**
- Templates are DUPLICATED (not referenced) when creating new events
- All duplicated data is fully independent and editable
- No "locked" or "protected" behavior for duplicated data

---

## Architecture

### 1. Template Sources

#### A. **WPT Standard Template** (Official)
**File:** `lib/mockData.ts`
**Exports:**
- `WPT_DEFAULT_TEMPLATE_CATEGORIES` - 12 official WPT categories
- `WPT_DEFAULT_TEMPLATE_PRODUCTS` - 2 standard packs

**Purpose:**
- Defines the official World Pizza Trophy event structure
- Ensures consistency across all future events
- Used as default when creating new events

**Properties:**
```typescript
// ‚ùå NO id (generated on duplication via Firestore)
// ‚ùå NO eventId (set to newEventId on duplication)
// ‚ùå NO activeDates (must be configured per event)
```

#### B. **Existing Events**
**Source:** Firestore `categories` and `products` collections
**Purpose:** Copy setup from previous event editions
**Data:** Can be filtered by eventId and duplicated

### 2. Storage Model

```
mockData.ts (CODE)
    ‚Üì
Contains WPT_DEFAULT_TEMPLATE_*
    ‚Üì
Used ONLY for duplication
    ‚Üì
Never stored directly in Firestore
    ‚Üì
Never displayed as real event

Firestore (PRODUCTION DATA)
    ‚îú‚îÄ‚îÄ events/{eventId}
    ‚îú‚îÄ‚îÄ categories/{catId} (eventId = newEventId)
    ‚îú‚îÄ‚îÄ products/{prodId} (eventId = newEventId)
    ‚îî‚îÄ‚îÄ All data is FULLY EDITABLE & DELETABLE
```

---

## Workflow: Creating an Event from Template

### Step 1: User Opens CreateEventModal
**File:** `components/CreateEventModal.tsx`

User selects:
- Event name, year, dates
- **Content initialization option:**
  - üéØ **WPT Standard Template** (Recommended)
  - ÔøΩÔøΩ **Empty Event** (Custom setup)
  - üìã **Duplicate from Previous Event**

### Step 2: Event Creation Handler
**File:** `App.tsx` - `handleCreateEvent()`

```typescript
// 1Ô∏è‚É£ Create new event in Firestore
const newEventId = await createEvent({
  ...eventData,
  status: 'draft'
});

// 2Ô∏è‚É£ Duplicate template data (if selected)
if (copyFromEventId === 'default_template') {
  // Duplicate WPT_DEFAULT_TEMPLATE_CATEGORIES
  for (const tpl of categoryTemplates) {
    const newCatData = {
      ...tpl,
      eventId: newEventId,      // ‚úÖ NEW eventId
      activeDates: [],           // ‚úÖ RESET dates
      // id is generated by Firestore
    };
    await createCategory(newCatData);
  }
  
  // Same for products...
}

// 3Ô∏è‚É£ Navigate to categories for configuration
setSelectedEventId(newEventId);
setActiveView('categories');
```

### Step 3: Duplicated Data is Independent
- ‚úÖ Each duplicated item gets a **NEW id** (Firestore auto-generated)
- ‚úÖ Linked to **NEW eventId** (completely independent)
- ‚úÖ Can be **edited, deleted, modified** freely
- ‚úÖ No relationship with template or source event

---

## Critical Rules

### ‚úÖ DO

1. **Generate new IDs via Firestore**
   ```typescript
   // ‚úì Correct: addDoc generates unique ID
   const docRef = await addDoc(collection(db, 'categories'), data);
   return docRef.id;
   ```

2. **Set eventId to the NEW event**
   ```typescript
   const newCatData = {
     ...templateData,
     eventId: newEventId  // ‚úì Links to NEW event
   };
   ```

3. **Reset dates for new event**
   ```typescript
   const newCatData = {
     ...templateData,
     activeDates: []  // ‚úì User will set dates later
   };
   ```

4. **Duplicate all properties exactly**
   ```typescript
   name, description, rules, unitPrice, maxSlots, durationMinutes, isActive
   ```

### ‚ùå DON'T

1. **Reuse old IDs**
   ```typescript
   // ‚úó WRONG: Never copy the old id
   const newCatData = {
     ...sourceCat,
     id: sourceCat.id  // ‚úó BAD - Creates reference!
   };
   ```

2. **Link to template**
   ```typescript
   // ‚úó WRONG: Don't reference template
   const newCatData = {
     eventId: 'default_template'  // ‚úó BAD
   };
   ```

3. **Use isTemplate flag**
   ```typescript
   // ‚úó WRONG: No special flag in Firestore
   isTemplate: true  // ‚úó BAD - Adds complexity
   ```

4. **Prevent deletion/editing**
   ```typescript
   // ‚úó WRONG: No "locked" or "protected" logic
   if (category.isTemplate) {
     throw new Error('Cannot delete');  // ‚úó BAD
   }
   ```

---

## Code References

### File Locations

| Component | File | Purpose |
|-----------|------|---------|
| **Template Definitions** | `lib/mockData.ts` | Define WPT_DEFAULT_TEMPLATE_* |
| **Template Hooks** | `lib/useFirebase.ts` | `useCategoryTemplates()`, `useProductTemplates()` |
| **UI for Creation** | `components/CreateEventModal.tsx` | User selects template option |
| **Duplication Logic** | `App.tsx` | `handleCreateEvent()` implements duplication |
| **Event CRUD** | `lib/useFirebase.ts` | `useEvents()`, `useCategories()`, `useProducts()` |

### Key Exports from mockData.ts

```typescript
export const WPT_DEFAULT_TEMPLATE_CATEGORIES: Omit<Category, "id" | "eventId" | "activeDates">[]
export const WPT_DEFAULT_TEMPLATE_PRODUCTS: Omit<Product, "id" | "eventId">[]
export const CATEGORY_TEMPLATES  // Legacy alias for backward compatibility
```

### Template Hook Usage

```typescript
const { templates: categoryTemplates } = useCategoryTemplates();
const { templates: productTemplates } = useProductTemplates();

// These read from Firestore collections:
// - 'categoryTemplates' (global, read-only)
// - 'productTemplates' (global, read-only)
```

---

## Date Handling

### Template Level
**In mockData.ts:** Templates have NO dates
```typescript
// Templates don't include date configuration
// User sets dates per event during configuration
```

### On Duplication
```typescript
// When duplicating, reset activeDates
const newCatData = {
  ...templateData,
  activeDates: []  // Reset - user configures later
};
```

### Frontend vs Firestore
- **Frontend:** Always use `Date` objects
- **Firestore:** Stores `Timestamp` objects
- **Conversion:** Happens in `useFirebase.ts` hooks

---

## Example: Complete Duplication Flow

### User Action
User creates event: "WPT 2026" from "WPT Standard Template"

### System Response

**1. CreateEventModal.tsx**
```
User selects:
- Name: "WPT 2026"
- Year: 2026
- Dates: Nov 3-4, 2026
- Source: "default_template"
‚Üí Calls handleCreateEvent()
```

**2. App.tsx - handleCreateEvent()**
```typescript
// Create event first
const newEventId = await createEvent({
  name: 'WPT 2026',
  eventYear: 2026,
  eventStartDate: new Date(2026, 10, 3),
  eventEndDate: new Date(2026, 10, 4),
  registrationDeadline: new Date(2026, 9, 20),
  status: 'draft'
});
// Result: newEventId = 'evt_abc123' (Firestore-generated)

// Duplicate categories
for (const tpl of categoryTemplates) {
  // tpl example:
  // { name: 'Pizza Classique', unitPrice: 120, ... }
  
  const newCatData = {
    name: 'Pizza Classique',
    unitPrice: 120,
    // ... other properties
    eventId: 'evt_abc123',  // ‚Üê NEW eventId
    activeDates: []         // ‚Üê RESET dates
  };
  
  // Firestore auto-generates catId
  const catId = await createCategory(newCatData);
  // Result: catId = 'cat_xyz789'
}

// Result in Firestore:
// {
//   id: 'cat_xyz789',
//   eventId: 'evt_abc123',    ‚Üê Linked to new event
//   name: 'Pizza Classique',
//   activeDates: [],          ‚Üê To be configured
//   isActive: true,
//   ... (all other props)
// }
```

**3. Firestore State**
```
events/evt_abc123
‚îú‚îÄ‚îÄ name: "WPT 2026"
‚îú‚îÄ‚îÄ status: "draft"
‚îî‚îÄ‚îÄ dates: 2026-11-03 to 2026-11-04

categories/cat_xyz789
‚îú‚îÄ‚îÄ eventId: "evt_abc123"    ‚Üê Independent link
‚îú‚îÄ‚îÄ name: "Pizza Classique"
‚îú‚îÄ‚îÄ activeDates: []          ‚Üê Ready to configure
‚îî‚îÄ‚îÄ ... (other properties)

categories/cat_uvw456
‚îú‚îÄ‚îÄ eventId: "evt_abc123"    ‚Üê Independent link
‚îú‚îÄ‚îÄ name: "Calzone"
‚îî‚îÄ‚îÄ ...

(... 10 more categories, 2 products)
```

**4. User Experience**
- ‚úÖ New event "WPT 2026" appears in sidebar
- ‚úÖ All 12 categories are pre-loaded
- ‚úÖ All 2 products are pre-loaded
- ‚úÖ User navigates to Categories view
- ‚úÖ User sets `activeDates` for each category
- ‚úÖ User can edit/delete categories without restriction
- ‚ùå NO "template locked" behavior
- ‚ùå NO connection to template data

---

## Template Maintenance

### When to Update Templates

Update `WPT_DEFAULT_TEMPLATE_CATEGORIES` or `WPT_DEFAULT_TEMPLATE_PRODUCTS` when:
- ‚úÖ Official WPT rules change
- ‚úÖ New official categories are added
- ‚úÖ Official pricing changes
- ‚úÖ Competition structure evolves

### Process

1. **Update mockData.ts**
   ```typescript
   export const WPT_DEFAULT_TEMPLATE_CATEGORIES = [
     // Update category list
   ];
   ```

2. **Deploy code**
   - The change is effective immediately for NEW events

3. **Existing events are UNAFFECTED**
   - Already-created events retain their duplicated data
   - Old events can still be copied (using their current data)

---

## Testing the System

### Unit Test Example
```typescript
test('Event duplication creates independent data', async () => {
  // 1. Create event from template
  const newEventId = await createEvent({...});
  await duplicateTemplate(newEventId, categoryTemplates);
  
  // 2. Verify categories are linked to NEW event
  const categories = await getCategories(newEventId);
  expect(categories[0].eventId).toBe(newEventId);
  expect(categories[0].id).not.toBe(undefined);  // Has unique ID
  
  // 3. Delete category (should NOT affect template)
  await deleteCategory(categories[0].id);
  const remaining = await getCategories(newEventId);
  expect(remaining.length).toBe(11);
});
```

### Manual Testing
1. Create new event with "WPT Standard Template"
2. Verify all 12 categories appear
3. Verify all 2 products appear
4. Edit category name ‚Üí should update only that event
5. Delete category ‚Üí should affect only that event
6. Create another event ‚Üí should have fresh copy of all templates

---

## Troubleshooting

### Issue: "Category is locked, cannot edit"
**Solution:** Remove any `isTemplate` or `locked` flag checks in code
- Templates should NOT restrict editing

### Issue: "Template categories don't appear"
**Check:**
1. Is `categoryTemplates` hook loading from Firestore?
2. Are there items in `categoryTemplates` collection?
3. Is the duplication loop executing (`handleCreateEvent` logs)?

### Issue: "Created categories are linked to wrong event"
**Check:**
1. Is `eventId: newEventId` set in duplication?
2. Verify Firestore documents have correct `eventId`

### Issue: "Categories from different events mixed"
**Check:**
1. Are hooks filtering by `eventId`?
2. `useCategories(eventId)` should filter: `where('eventId', '==', eventId)`

---

## Migration Guide

If migrating from old system with real data in mockData.ts:

### Before (BAD)
```typescript
// mockData.ts contains actual event data
export const MOCK_EVENTS = [{id: 'evt_2025', ...}];
export const INITIAL_CATEGORIES = [{id: 'cat_1', eventId: 'evt_2025', ...}];
```

### After (GOOD)
```typescript
// mockData.ts contains ONLY templates
export const WPT_DEFAULT_TEMPLATE_CATEGORIES = [
  {name: 'Pizza Classique', ...}  // NO id, NO eventId
];
// Real data lives in Firestore
```

---

## Summary

| Aspect | Before | After |
|--------|--------|-------|
| Template Location | Hard to identify | Clear in mockData.ts |
| Real Data Location | Mixed in code | Firestore only |
| Data Duplication | Unclear | Explicit in handleCreateEvent() |
| Editing Templates | Affects all events | Only new events |
| Deleting Categories | Might be blocked | Always allowed |
| Event Independence | Questions | Guaranteed |

**Result:** Clean, maintainable, and developer-friendly template system ‚úÖ

